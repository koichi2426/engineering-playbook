# 3. データベース設計 (Database Design)

このドキュメントは、データベースのスキーマ設計、命名規則、および操作に関する共通の原則を定義します。

## 1. 基本方針 (Base Principles)

1.  **ORMの使用:**
    * 原則として、データベースへの直接アクセス（生SQLの実行）は避け、**ORM (Object-Relational Mapper)**（例: SQLAlchemy, Prisma, GORM）を使用します。
    * これにより、コードの可読性が向上し、SQLインジェクションのリスクが低減されます。
    * 生SQLが必要な場合は、リポジトリ層（`infrastructure`）にカプセル化し、レビューを必須とします。
2.  **マイグレーション (Migration):**
    * データベーススキーマ（テーブル構造）の変更は、**マイグレーションツール**（例: Alembic, Prisma Migrate）を**必ず**使用します。
    * 開発環境であっても、データベースを手動で直接変更（`ALTER TABLE`など）することは禁止します。
3.  **正規化 (Normalization):**
    * データの冗長性を排除し、一貫性を保つため、原則として第三正規形（3NF）を目指して設計します。
    * ただし、`GET` リクエストのパフォーマンスが極端に重要な場合、レビュープロセスを経て、意図的な非正規化（Denormalization）を許可することがあります。

## 2. 命名規則 (Naming Convention)

1.  **スネークケース (snake_case):**
    * テーブル名、カラム名はすべて小文字のスネークケースを使用します。
    * 良い例: `user_profiles`, `created_at`
    * 悪い例: `UserProfiles`, `createdAt`
2.  **テーブル名:**
    * リソース（エンティティ）の**複数形**を使用します。
    * 良い例: `users`, `articles`, `categories`
    * 悪い例: `user`, `article_table`
3.  **カラム名:**
    * 意図が明確な英語の**単数形**（または適切な名詞）を使用します。
    * 良い例: `user_id`, `first_name`, `is_active`
4.  **プライマリキー (PK):**
    * 原則として `id` という名前のAuto Incrementな整数（`BIGINT`推奨）またはUUIDを使用します。
5.  **フォーリンキー (FK):**
    * 参照するテーブルの単数形 + `_id` という形式にします。
    * 例: `users` テーブルの `id` を参照する場合 → `user_id`

## 3. インデックス (Indexes)

1.  **プライマリキー (PK):** すべてのテーブルは必ずPKを持つ必要があります。
2.  **フォーリンキー (FK):** FKとして定義されたカラムには、原則として必ずインデックスを作成します。
3.  **検索対象:** `WHERE` 句で頻繁に検索条件として使用されるカラム（例: `email`, `status`, `created_at`）には、インデックスの作成を積極的に検討します。

## 4. N+1問題の防止

ORMを使用する際、最も注意すべきパフォーマンスの落とし穴は「N+1クエリ問題」です。

* **問題の例:** 100件の記事を取得し、その後ループ内で記事ごとに著者の情報を取得する。（1 + 100回のクエリが発生）
* **対策:** リソースの一覧を取得する際は、関連するリソースも**Eager Loading**（`JOIN` や `IN` を使った事前読み込み）でまとめて取得することを原則とします。
    * 例: `/articles` を取得する際は、`users` テーブルも `JOIN` して取得する。